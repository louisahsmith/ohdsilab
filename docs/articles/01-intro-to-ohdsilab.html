<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to ohdsilab • ohdsilab</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to ohdsilab">
<meta property="og:description" content="ohdsilab">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ohdsilab</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01-intro-to-ohdsilab.html">Introduction to ohdsilab</a>
    </li>
    <li>
      <a href="../articles/02-getting-started-with-box.html">Getting Started with the OHDSI-Lab Box</a>
    </li>
    <li>
      <a href="../articles/03-Generating-a-cohort.html">Generating a cohort</a>
    </li>
    <li>
      <a href="../articles/04-feature-extraction-covariates.html">Generating Covariates and Table 1</a>
    </li>
    <li>
      <a href="../articles/05-working-with-omop-cdm.html">Working with Data from the ohdsilab database</a>
    </li>
    <li>
      <a href="../articles/06-working-in-allofus.html">Intro to the AllofUs Workbench</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to ohdsilab</h1>
            
      
      
      <div class="hidden name"><code>01-intro-to-ohdsilab.Rmd</code></div>

    </div>

    
    
<p>The goals of the ohdsilab R package are two fold: (1) To streamline
working with the OHDSI-Lab data at the Roux Institute (and other OMOP
CDM databases) and (2) To provde an easier onramp for students and
researchers new to working with the OMOP CDM or SQL databases. To do
this, the package contains functions and template code snippets to
facilitate easier use of the Ohdsilab. These functions and snippits
build on existing OHDSI R packages like {DatabaseConnector} as well as
standard R packages like {dplyr} and {tidyr}. The package also contains
a number of vingettes intended for R users who are new to OHDSI-Lab, the
OMOP CDM, or working with data in SQL databases from R.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p><strong><em>For OHDSI-Lab users, we strongly recommend using the
{renv} R package to install ohdsilab and all other packages on your
OHDSI-Lab Box/Workspace. Installation without {renv} is likely to fail
due to permission restrictions. A guide to using {renv} is here: <a href="https://rstudio.github.io/renv/articles/renv.html" class="external-link uri">https://rstudio.github.io/renv/articles/renv.html</a>.</em></strong></p>
<p>Installation only needs to be done once, unless you are updating the
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"roux-ohdsi/ohdsilab"</span><span class="op">)</span></span></code></pre></div>
<p>or with {renv}:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"roux-ohdsi/ohdsilab"</span><span class="op">)</span></span></code></pre></div>
<p>If you want to also install OHDSI packages (e.g., DatabaseConnector),
set dependencies = “Suggests”. This is recommended unless you are
working on the AllofUs Researcher workbench as these packages take a
while to install and are not terribly useful with the AllofUs database
setup.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># using {remotes}</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"roux-ohdsi/ohdsilab"</span>, dependencies <span class="op">=</span> <span class="st">"Suggests"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-the-ohdsilab-package">Load the ohdsilab package<a class="anchor" aria-label="anchor" href="#load-the-ohdsilab-package"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/DatabaseConnector/" class="external-link">DatabaseConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-lib.github.io/keyring/index.html" class="external-link">keyring</a></span><span class="op">)</span></span></code></pre></div>
<p><em><code><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">library(ohdsilab)</a></code> should also load
{DatabaseConnector}, {keyring}, and other dependencies, but you might
want to explicitly load them for transparency.</em></p>
</div>
<div class="section level2">
<h2 id="snippets">Snippets<a class="anchor" aria-label="anchor" href="#snippets"></a>
</h2>
<p>{ohdsilab} stores some basic <a href="https://rstudio.github.io/rstudio-extensions/rstudio_snippets.html" class="external-link">snippets</a>
for quick starting new scripts and projects. Follow the instructions in
the link above to install the snippets. They are located in the
/snippets folder in the package. The easiest way to copy them is copy
text below the first line from the raw file on github: <a href="https://raw.githubusercontent.com/roux-ohdsi/ohdsilab/main/snippets/snippets" class="external-link uri">https://raw.githubusercontent.com/roux-ohdsi/ohdsilab/main/snippets/snippets</a>.
If you notice any mistakes or have any suggestions for the snippets,
feel free to create a pull request or start an issue on the github page.
The snippet you’ll find most useful to begin with is probably
ohdsi_new_script.</p>
<p>Current snippets:</p>
<p>Polished:</p>
<ul>
<li>ohdsi_new_script</li>
</ul>
<p>In the works:</p>
<ul>
<li>ohdsi_new_project</li>
<li>ohdsi_creds</li>
<li>ohdsi_db</li>
<li>ohdsi_db_variables</li>
<li>ohdsi_db_connect</li>
<li>ohdsi_api_auth</li>
<li>ohdsi_api_cohort_definition</li>
</ul>
<!-- ## Functions --><!-- These are in development and being updated frequently.  --><!-- - `dbi_collect()` is a different version of the `collect()` function that uses DBI instead of dbplyr. There are --><!-- occasional errors with the `collect()` function where not all rows of the query are returned because the query --><!-- times out. In these cases, use the `dbi_collect()` function.  --><!-- - `rb()` is a function to "ROLLBACK" in redshift SQL. This is necessary when there is a mistake in the dbplyr generated --><!-- SQL code. You can use `rb()` instead of disconnecting and reconnecting to the database. --><!-- - `insertTable_chunks()` writes a table to your user schema in chunks to reduce writing time. --><!-- - `omop_join()` is a shortcut for a join from an existing query (e.g., a dplyr pipe chunk) to an omop table without --><!-- having to reference the connection and schema.  --><!-- - `icd2omop()` and `icd2omop2()` map a dataframe or vector of icd 9 or 10 codes to OMOP concept codes --><!-- - `cpt2omop()` maps a vector of cpt codes to omop concept codes. It can be used for any standardized vocabulary, --><!-- not just CPT4. (ICD9/10 are not considered standardized) --><!-- - `str_insert()` and `icd_periods()` help to insert periods into icd codes when they come without. This --><!-- is typically a necessary step before mapping to OMOP codes.  --><!-- - `aou_connect()`, `aou_ls()`, `aou_retrieve_from_bucket()`, and `aou_save_to_bucket()` are useful for --><!-- streamlining common code in the AllofUs workbench. --><!-- - `bookstore()` checks to see if packages are installed before loading them via `library()`. This is experimental --><!-- and could be used in place of `install.packages()` + `library()`.  -->
</div>
<div class="section level2">
<h2 id="connecting-to-a-database">Connecting to a database<a class="anchor" aria-label="anchor" href="#connecting-to-a-database"></a>
</h2>
<p>If this is the first time connecting on your computer (i.e., your
virual machine using the Amazon Workspaces), you’ll need to set your
credientials before it will work. The snippet ohdsi_creds will create
that code for you. When you run each line, it’ll generate a pop up where
you can enter your database/ohdsilab username (something like usr999)
and your password (which is in your email). After setting the
credentials, you shouldn’t have to do it again.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Credentials</span></span>
<span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"lab_user"</span>, prompt <span class="op">=</span> <span class="st">"Username for this workspace"</span><span class="op">)</span></span>
<span><span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_set</a></span><span class="op">(</span><span class="st">"lab_password"</span>, prompt <span class="op">=</span> <span class="st">"Password for this workspace"</span><span class="op">)</span></span></code></pre></div>
<p>The following code was generated using the ohdsi_new_script snippet.
It creates a template for the basic code needed to connect to the
database. Now that you’ve set up your credentials, see if it’ll run
without errors. Note that you’ll also need to be using RStudio within
the Amazon workspace box or you need to use the global connect VPN.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ==============================================================================</span></span>
<span><span class="co"># Packages =====================================================================</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-lib.github.io/keyring/index.html" class="external-link">keyring</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/DatabaseConnector/" class="external-link">DatabaseConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roux-ohdsi.github.io/ohdsilab/" class="external-link">ohdsilab</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Credentials ==================================================================</span></span>
<span><span class="va">usr</span> <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_user"</span><span class="op">)</span></span>
<span><span class="va">pw</span>  <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_password"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DB Connections ===============================================================</span></span>
<span><span class="va">atlas_url</span> <span class="op">=</span> <span class="st">"https://atlas.roux-ohdsi-prod.aws.northeastern.edu/WebAPI"</span></span>
<span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_user"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Create the connection</span></span>
<span><span class="va">con</span> <span class="op">=</span>  <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span></span>
<span>  dbms <span class="op">=</span> <span class="st">"redshift"</span>,</span>
<span>  server <span class="op">=</span> <span class="st">"ohdsi-lab-redshift-cluster-prod.clsyktjhufn7.us-east-1.redshift.amazonaws.com/ohdsi_lab"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">5439</span>,</span>
<span>  user <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_user"</span><span class="op">)</span>,</span>
<span>  password <span class="op">=</span> <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_password"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="co"># make it easier for some r functions to find the database</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># End Setup ====================================================================</span></span>
<span><span class="co"># ==============================================================================</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="querying-the-database">Querying the database<a class="anchor" aria-label="anchor" href="#querying-the-database"></a>
</h2>
<p>The ohdsilab pharmetrics database uses amazon redshift SQL and the
OMOP CDM version 5.3.</p>
<p>You can see information in the 5.3 OMOP version here: <a href="https://ohdsi.github.io/CommonDataModel/cdm53.html" class="external-link uri">https://ohdsi.github.io/CommonDataModel/cdm53.html</a>. The
database organization looks like this (this is a very similar OMOP CDM
5.4 - there are only very minor differences).</p>
<p><img src="https://ohdsi.github.io/CommonDataModel/images/cdm54.png" width="100%"></p>
<p>A more comprehensive diagram with information about the columns in
each of the tables can be found here: <a href="http://ohdsi.github.io/CommonDataModel/cdm54erd.html" class="external-link uri">http://ohdsi.github.io/CommonDataModel/cdm54erd.html</a></p>
<p>The data help in the database is stored under the cdm schema You can
think of a schema as kind of like a subfolder in the database. So the
pharmetrics data is stored in ohdsilab/omop_cdm_53_pmtx_202203/… where
the … indicates what table you’re interested in.</p>
<p>To query a table in pharmetrics you might write a line of code like
this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"omop_cdm_53_pmtx_202203"</span>, <span class="st">"concept"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This code is looking for the concept table in the pharmetrics schema
which is in the ohdsilab database. You can also see the concept table in
the orange box labelled “Standardized Vocabularies” in the picture
above.</p>
<p>You also have your own schema (sometimes called your “scratchpad”)
where you can save information pertinent to your studies. If you were
usr999, you could access a table (that you have previously created) like
this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"usr999"</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Because these tables are in the database, we can connect them
together. For example, you might use {cohortGenerator} to generate a
cohort table in your schema (“myCohort”). Your cohort table includes a
column of person_id’s (and some other information) that you can use to
reduce the giant amount of data in pharmetrics - usually with an
<code>inner_join</code>.</p>
<p>(See <a href="https://ohdsi.github.io/CohortGenerator/articles/GeneratingCohorts.html" class="external-link uri">https://ohdsi.github.io/CohortGenerator/articles/GeneratingCohorts.html</a>
for a tutorial)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"usr999"</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="st">"omop_cdm_53_pmtx_202203"</span>, <span class="st">"person"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"person_id"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Remembering the name of the database schema and your usr schema can
be a bit annoying. That’s why the ohdsi_new_script snipped also includes
the following lines of code, so you can just reference these strings
using the variables <code>cdm_schema</code> and
<code>write_schema</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm_schema</span> <span class="op">=</span> <span class="st">"omop_cdm_53_pmtx_202203"</span></span>
<span><span class="va">write_schema</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"work_"</span>, <span class="fu">keyring</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keyring/man/key_get.html" class="external-link">key_get</a></span><span class="op">(</span><span class="st">"lab_user"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>It might look like this:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">write_schema</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>      <span class="va">con</span>,</span>
<span>      <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">cdm_schema</span>, <span class="st">"person"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"person_id"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>This can still be quite a bit of code for each join. Additionally,
there are some known bugs with using the dplyr *_join functions with our
redshift database isntances. For these reasons, we recommend that you
use the <code><a href="../reference/omop_join.html">ohdsilab::omop_join()</a></code> function can help streamline
your code. It’s a wrapper for the dplyr <code>join</code> functions that
also includes some workarounds for a few known bugs in the backround so
that you don’t have to worry about them as much.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>,</span>
<span>    <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">write_schema</span>, <span class="st">"myCohort"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">ohdsilab</span><span class="fu">::</span><span class="fu"><a href="../reference/omop_join.html">omop_join</a></span><span class="op">(</span><span class="st">"person"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
<p>It works because we set the default connection and cdm_schema using
these lines of code from the ohdsi_new_script snippet. The
<code><a href="../reference/omop_join.html">omop_join()</a></code> function will look for these defaults first,
and if it doesn’t find them (because you didn’t run these two lines),
will let you know you need to provide them directly. Note that if you
want to point omop_join() to your user scratchpad, you only need to set
<code>schema = write_schema</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>con.default.value <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>schema.default.value <span class="op">=</span> <span class="va">cdm_schema</span><span class="op">)</span></span></code></pre></div>
<p>Here’s a toy example of how we can put all this information together.
We can extract all conditions for women born in 2002. Try to run these
chunks to make sure everything is working.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Start with a pointer to a table in the database. It could be in the cdm_schema</span></span>
<span><span class="co"># or in your user write_schema.</span></span>
<span><span class="va">female_2002</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/inDatabaseSchema.html" class="external-link">inDatabaseSchema</a></span><span class="op">(</span><span class="va">cdm_schema</span>, <span class="st">"person"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># filter the data for women born in 2002</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year_of_birth</span> <span class="op">==</span> <span class="fl">2002</span>, <span class="va">gender_source_value</span> <span class="op">==</span> <span class="st">"F"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># select only the necessary columns</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">person_id</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="co"># join to the condition occurrence table using an inner join</span></span>
<span>    <span class="fu"><a href="../reference/omop_join.html">omop_join</a></span><span class="op">(</span><span class="st">"condition_occurrence"</span>, type <span class="op">=</span> <span class="st">"inner"</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run to see a preview of the top 10 rows</span></span>
<span><span class="va">female_2002</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># how many rows are in our data?</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="va">female_2002</span><span class="op">)</span></span></code></pre></div>
<p>If you get an error from the database, you often will need to
“rollback” before running a new command. The error that tells you that
you need to “rollback” usually looks like this:</p>
<pre><code>Error in `db_query_fields.DBIConnection()`:
! Can't query fields.
Caused by error in `.createErrorReport()`:
! Error executing SQL:
com.amazon.redshift.util.RedshiftException: ERROR: current transaction is aborted, commands ignored until end of transaction block
An error report has been created at .../errorReportSql.txt
Run `rlang::last_trace()` to see where the error occurred.</code></pre>
<p>A rollback is essentially like going back in time to a world before
you ran the chunk of code that caused an error. You can easily do this
using ohdsilab provided you’ve set the connection and schema default
values above.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rb.html">rb</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This is synonymous with running.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/executeSql.html" class="external-link">executeSql</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"ROLLBACK;"</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Louisa Smith, Rob Cavanaugh.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
